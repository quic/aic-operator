ARG QAIC_SRC_IMG
ARG QAIC_VER
ARG DTK_AUTO


FROM ${QAIC_SRC_IMG}:${QAIC_VER} AS qaic-kmd-src


FROM ${DTK_AUTO} AS kmd_builder
ARG QAIC_VER
ARG KERNEL_FULL_VERSION
COPY --from=qaic-kmd-src /src /usr/src/qaic-${QAIC_VER}
WORKDIR /usr/src/qaic-${QAIC_VER}
RUN ./dkms_prebuild.sh ${KERNEL_FULL_VERSION} /lib/modules/${KERNEL_FULL_VERSION}/build && KERNELRELEASE=${KERNEL_FULL_VERSION} make


FROM registry.access.redhat.com/ubi9/ubi-minimal
ARG QAIC_VER
ARG KERNEL_FULL_VERSION

# Install required packages in one layer
RUN microdnf -y install kmod && \
    microdnf clean all && \
    rm -rf /var/cache/yum

# Create module directory
RUN mkdir -p /opt/lib/modules/${KERNEL_FULL_VERSION}

# Copy firmware
COPY --from=qaic-kmd-src /firmware/updates /firmware

# Copy kernel modules
COPY --from=kmd_builder /usr/src/qaic-${QAIC_VER}/qaic/qaic.ko /opt/lib/modules/${KERNEL_FULL_VERSION}/
COPY --from=kmd_builder /usr/src/qaic-${QAIC_VER}/qrtr/qrtr-mhi.ko /opt/lib/modules/${KERNEL_FULL_VERSION}/
COPY --from=kmd_builder /usr/src/qaic-${QAIC_VER}/switch/switchtec.ko /opt/lib/modules/${KERNEL_FULL_VERSION}/
COPY --from=kmd_builder /usr/src/qaic-${QAIC_VER}/mhi/host/mhi.ko /opt/lib/modules/${KERNEL_FULL_VERSION}/

# Generate module dependencies
RUN /usr/sbin/depmod -b /opt ${KERNEL_FULL_VERSION}